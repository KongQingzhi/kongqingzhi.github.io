# 微信小程序订阅消息

## 接口

使用 `wx.requestSubscribeMessage(Object object)` 接口调起客户端小程序订阅消息界面，返回用户订阅消息的操作结果。

- 支持以 `Promise` 风格调用

> [!NOTE]
>
> - 一次性模板 id 和永久模板 id 不可同时使用。
> - 低版本基础库2.4.4~2.8.3 已支持订阅消息接口调用，仅支持传入一个一次性 tmplId / 永久 tmplId。
> - 2.8.2 版本开始，用户发生点击行为或者发起支付回调后，才可以调起订阅消息界面。
> - 2.10.0 版本开始，开发版和体验版小程序将禁止使用模板消息 formId。
> - 一次授权调用里，每个tmplId对应的模板标题不能存在相同的，若出现相同的，只保留一个。
> - 2.10.0 版本开始，支持订阅语音消息提醒，详情

## 参数

| 属性     | 类型     | 必填 | 说明                                                                                                                                                                                                                                                                                                                                                   |
| -------- | -------- | ---- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| tmplIds  | Array    | 是   | 需要订阅的消息模板的id的集合，一次调用最多可订阅3条消息（注意：iOS客户端7.0.6版本、Android客户端7.0.7版本之后的一次性订阅/长期订阅才支持多个模板消息，iOS客户端7.0.5版本、Android客户端7.0.6版本之前的一次订阅只支持一个模板消息）消息模板id在[微信公众平台(mp.weixin.qq.com)-功能-订阅消息]中配置。每个tmplId对应的模板标题需要不相同，否则会被过滤。 |
| success  | function | 否   | 接口调用成功的回调函数                                                                                                                                                                                                                                                                                                                                 |
| fail     | function | 否   | 接口调用失败的回调函数                                                                                                                                                                                                                                                                                                                                 |
| complete | function | 否   | 接口调用结束的回调函数（调用成功、失败都会执行）                                                                                                                                                                                                                                                                                                       |

### success

| 属性          | 类型   | 说明                                                                                                                                                                                                                                           |
| ------------- | ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| errMsg        | String | 接口调用成功时errMsg值为'requestSubscribeMessage:ok'                                                                                                                                                                                           |
| [TEMPLATE_ID] | String | [TEMPLATE_ID]是动态的键，即模板id，值包括'accept'、'reject'、'ban'、'filter'。'accept'表示用户同意订阅该条id对应的模板消息，'reject'表示用户拒绝订阅该条id对应的模板消息，'ban'表示已被后台封禁，'filter'表示该模板因为模板标题同名被后台过滤. |

### fail

| 属性    | 类型   | 说明                 |
| ------- | ------ | -------------------- |
| errMsg  | String | 接口调用失败错误信息 |
| errCode | Number | 接口调用失败错误码   |

## 代码

> [!WARNING]
>
> - 需要点击事件触发，否则报错。
> - 在调用接口之前不允许有异步请求，否则无法调用接口。

```html
<view>
  <button bind:tap="handleClick">订阅消息</button>
</view>
```

```ts
Page({
  methods: {
    async handleClick() {
      try {
        const res = await wx.requestSubscribeMessage({
          tmplIds: ['I8x--Zc28Psar7RVC_cOTa31OLKvaMMln8Zc12g313bE'],
        });
        console.log(res);
      } catch (err) {
        console.log(err);
      }
    },
  },
});
```
